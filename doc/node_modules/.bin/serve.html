<!DOCTYPE html>
<html>
<head>
  <title>serve</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/.bin/serve";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>serve</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>source/main.ts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> { cwd <span class="hljs-keyword">as</span> getPwd, exit, env <span class="hljs-keyword">as</span> env2, stdout } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:process"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"node:path"</span>;
<span class="hljs-keyword">import</span> chalk4 <span class="hljs-keyword">from</span> <span class="hljs-string">"chalk"</span>;
<span class="hljs-keyword">import</span> boxen <span class="hljs-keyword">from</span> <span class="hljs-string">"boxen"</span>;
<span class="hljs-keyword">import</span> clipboard <span class="hljs-keyword">from</span> <span class="hljs-string">"clipboardy"</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>package.json</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> package_default = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"serve"</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">"14.2.0"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Static file serving and directory listing"</span>,
  <span class="hljs-attr">keywords</span>: [
    <span class="hljs-string">"vercel"</span>,
    <span class="hljs-string">"serve"</span>,
    <span class="hljs-string">"micro"</span>,
    <span class="hljs-string">"http-server"</span>
  ],
  <span class="hljs-attr">repository</span>: <span class="hljs-string">"vercel/serve"</span>,
  <span class="hljs-attr">license</span>: <span class="hljs-string">"MIT"</span>,
  <span class="hljs-attr">type</span>: <span class="hljs-string">"module"</span>,
  <span class="hljs-attr">bin</span>: {
    <span class="hljs-attr">serve</span>: <span class="hljs-string">"./build/main.js"</span>
  },
  <span class="hljs-attr">files</span>: [
    <span class="hljs-string">"build/"</span>
  ],
  <span class="hljs-attr">engines</span>: {
    <span class="hljs-attr">node</span>: <span class="hljs-string">"&gt;= 14"</span>
  },
  <span class="hljs-attr">scripts</span>: {
    <span class="hljs-attr">develop</span>: <span class="hljs-string">"tsx watch ./source/main.ts"</span>,
    <span class="hljs-attr">start</span>: <span class="hljs-string">"node ./build/main.js"</span>,
    <span class="hljs-attr">compile</span>: <span class="hljs-string">"tsup ./source/main.ts"</span>,
    <span class="hljs-string">"test:tsc"</span>: <span class="hljs-string">"tsc --project tsconfig.json"</span>,
    <span class="hljs-string">"test:unit"</span>: <span class="hljs-string">"vitest run --config config/vitest.ts"</span>,
    <span class="hljs-string">"test:watch"</span>: <span class="hljs-string">"vitest watch --config config/vitest.ts"</span>,
    <span class="hljs-attr">test</span>: <span class="hljs-string">"pnpm test:tsc &amp;&amp; pnpm test:unit"</span>,
    <span class="hljs-string">"lint:code"</span>: <span class="hljs-string">"eslint --max-warnings 0 source/**/*.ts"</span>,
    <span class="hljs-string">"lint:style"</span>: <span class="hljs-string">"prettier --check --ignore-path .gitignore ."</span>,
    <span class="hljs-attr">lint</span>: <span class="hljs-string">"pnpm lint:code &amp;&amp; pnpm lint:style"</span>,
    <span class="hljs-attr">format</span>: <span class="hljs-string">"prettier --write --ignore-path .gitignore ."</span>,
    <span class="hljs-attr">prepare</span>: <span class="hljs-string">"husky install config/husky &amp;&amp; pnpm compile"</span>
  },
  <span class="hljs-attr">dependencies</span>: {
    <span class="hljs-string">"@zeit/schemas"</span>: <span class="hljs-string">"2.29.0"</span>,
    <span class="hljs-attr">ajv</span>: <span class="hljs-string">"8.11.0"</span>,
    <span class="hljs-attr">arg</span>: <span class="hljs-string">"5.0.2"</span>,
    <span class="hljs-attr">boxen</span>: <span class="hljs-string">"7.0.0"</span>,
    <span class="hljs-attr">chalk</span>: <span class="hljs-string">"5.0.1"</span>,
    <span class="hljs-string">"chalk-template"</span>: <span class="hljs-string">"0.4.0"</span>,
    <span class="hljs-attr">clipboardy</span>: <span class="hljs-string">"3.0.0"</span>,
    <span class="hljs-attr">compression</span>: <span class="hljs-string">"1.7.4"</span>,
    <span class="hljs-string">"is-port-reachable"</span>: <span class="hljs-string">"4.0.0"</span>,
    <span class="hljs-string">"serve-handler"</span>: <span class="hljs-string">"6.1.5"</span>,
    <span class="hljs-string">"update-check"</span>: <span class="hljs-string">"1.5.4"</span>
  },
  <span class="hljs-attr">devDependencies</span>: {
    <span class="hljs-string">"@types/compression"</span>: <span class="hljs-string">"1.7.2"</span>,
    <span class="hljs-string">"@types/serve-handler"</span>: <span class="hljs-string">"6.1.1"</span>,
    <span class="hljs-string">"@vercel/style-guide"</span>: <span class="hljs-string">"3.0.0"</span>,
    <span class="hljs-attr">c8</span>: <span class="hljs-string">"7.12.0"</span>,
    <span class="hljs-attr">eslint</span>: <span class="hljs-string">"8.19.0"</span>,
    <span class="hljs-attr">got</span>: <span class="hljs-string">"12.1.0"</span>,
    <span class="hljs-attr">husky</span>: <span class="hljs-string">"8.0.1"</span>,
    <span class="hljs-string">"lint-staged"</span>: <span class="hljs-string">"13.0.3"</span>,
    <span class="hljs-attr">prettier</span>: <span class="hljs-string">"2.7.1"</span>,
    <span class="hljs-attr">tsup</span>: <span class="hljs-string">"6.1.3"</span>,
    <span class="hljs-attr">tsx</span>: <span class="hljs-string">"3.7.1"</span>,
    <span class="hljs-attr">typescript</span>: <span class="hljs-string">"4.6.4"</span>,
    <span class="hljs-attr">vitest</span>: <span class="hljs-string">"0.18.0"</span>
  },
  <span class="hljs-attr">tsup</span>: {
    <span class="hljs-attr">target</span>: <span class="hljs-string">"esnext"</span>,
    <span class="hljs-attr">format</span>: [
      <span class="hljs-string">"esm"</span>
    ],
    <span class="hljs-attr">outDir</span>: <span class="hljs-string">"./build/"</span>
  },
  <span class="hljs-attr">prettier</span>: <span class="hljs-string">"@vercel/style-guide/prettier"</span>,
  <span class="hljs-attr">eslintConfig</span>: {
    <span class="hljs-attr">extends</span>: [
      <span class="hljs-string">"./node_modules/@vercel/style-guide/eslint/node.js"</span>,
      <span class="hljs-string">"./node_modules/@vercel/style-guide/eslint/typescript.js"</span>
    ],
    <span class="hljs-attr">parserOptions</span>: {
      <span class="hljs-attr">project</span>: <span class="hljs-string">"tsconfig.json"</span>
    }
  },
  <span class="hljs-string">"lint-staged"</span>: {
    <span class="hljs-string">"*"</span>: [
      <span class="hljs-string">"prettier --ignore-unknown --write"</span>
    ],
    <span class="hljs-string">"source/**/*.ts"</span>: [
      <span class="hljs-string">"eslint --max-warnings 0 --fix"</span>,
      <span class="hljs-string">"vitest related --run"</span>
    ],
    <span class="hljs-attr">tests</span>: [
      <span class="hljs-string">"vitest --run"</span>
    ]
  }
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>source/utilities/promise.ts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> { promisify } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:util"</span>;
<span class="hljs-keyword">var</span> resolve = <span class="hljs-keyword">async</span> (promiseLike) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> promiseLike;
    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">void</span> <span class="hljs-number">0</span>, data];
  } <span class="hljs-keyword">catch</span> (error2) {
    <span class="hljs-keyword">return</span> [error2, <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>];
  }
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>source/utilities/server.ts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> http2 <span class="hljs-keyword">from</span> <span class="hljs-string">"node:http"</span>;
<span class="hljs-keyword">import</span> https <span class="hljs-keyword">from</span> <span class="hljs-string">"node:https"</span>;
<span class="hljs-keyword">import</span> { readFile } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:fs/promises"</span>;
<span class="hljs-keyword">import</span> handler <span class="hljs-keyword">from</span> <span class="hljs-string">"serve-handler"</span>;
<span class="hljs-keyword">import</span> compression <span class="hljs-keyword">from</span> <span class="hljs-string">"compression"</span>;
<span class="hljs-keyword">import</span> isPortReachable <span class="hljs-keyword">from</span> <span class="hljs-string">"is-port-reachable"</span>;
<span class="hljs-keyword">import</span> chalk2 <span class="hljs-keyword">from</span> <span class="hljs-string">"chalk"</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>source/utilities/http.ts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> { networkInterfaces <span class="hljs-keyword">as</span> getNetworkInterfaces } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:os"</span>;
<span class="hljs-keyword">var</span> networkInterfaces = getNetworkInterfaces();
<span class="hljs-keyword">var</span> registerCloseListener = <span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> {
  <span class="hljs-keyword">let</span> run = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (!run) {
      run = <span class="hljs-literal">true</span>;
      fn();
    }
  };
  process.on(<span class="hljs-string">"SIGINT"</span>, wrapper);
  process.on(<span class="hljs-string">"SIGTERM"</span>, wrapper);
  process.on(<span class="hljs-string">"exit"</span>, wrapper);
};
<span class="hljs-keyword">var</span> getNetworkAddress = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> interfaceDetails <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.values(networkInterfaces)) {
    <span class="hljs-keyword">if</span> (!interfaceDetails)
      <span class="hljs-keyword">continue</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> details <span class="hljs-keyword">of</span> interfaceDetails) {
      <span class="hljs-keyword">const</span> { address, family, internal } = details;
      <span class="hljs-keyword">if</span> (family === <span class="hljs-string">"IPv4"</span> &amp;&amp; !internal)
        <span class="hljs-keyword">return</span> address;
    }
  }
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>source/utilities/logger.ts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> chalk <span class="hljs-keyword">from</span> <span class="hljs-string">"chalk"</span>;
<span class="hljs-keyword">var</span> http = <span class="hljs-function">(<span class="hljs-params">...message</span>) =&gt;</span> <span class="hljs-built_in">console</span>.info(chalk.bgBlue.bold(<span class="hljs-string">" HTTP "</span>), ...message);
<span class="hljs-keyword">var</span> info = <span class="hljs-function">(<span class="hljs-params">...message</span>) =&gt;</span> <span class="hljs-built_in">console</span>.info(chalk.bgMagenta.bold(<span class="hljs-string">" INFO "</span>), ...message);
<span class="hljs-keyword">var</span> warn = <span class="hljs-function">(<span class="hljs-params">...message</span>) =&gt;</span> <span class="hljs-built_in">console</span>.error(chalk.bgYellow.bold(<span class="hljs-string">" WARN "</span>), ...message);
<span class="hljs-keyword">var</span> error = <span class="hljs-function">(<span class="hljs-params">...message</span>) =&gt;</span> <span class="hljs-built_in">console</span>.error(chalk.bgRed.bold(<span class="hljs-string">" ERROR "</span>), ...message);
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">console</span>.log;
<span class="hljs-keyword">var</span> logger = { http, info, warn, error, log };

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>source/utilities/server.ts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> compress = promisify(compression());
<span class="hljs-keyword">var</span> startServer = <span class="hljs-keyword">async</span> (endpoint, config2, args2, previous) =&gt; {
  <span class="hljs-keyword">const</span> serverHandler = <span class="hljs-function">(<span class="hljs-params">request, response</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> run = <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> requestTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      <span class="hljs-keyword">const</span> formattedTime = <span class="hljs-string">`<span class="hljs-subst">${requestTime.toLocaleDateString()}</span> <span class="hljs-subst">${requestTime.toLocaleTimeString()}</span>`</span>;
      <span class="hljs-keyword">const</span> ipAddress = request.socket.remoteAddress?.replace(<span class="hljs-string">"::ffff:"</span>, <span class="hljs-string">""</span>) ?? <span class="hljs-string">"unknown"</span>;
      <span class="hljs-keyword">const</span> requestUrl = <span class="hljs-string">`<span class="hljs-subst">${request.method ?? <span class="hljs-string">"GET"</span>}</span> <span class="hljs-subst">${request.url ?? <span class="hljs-string">"/"</span>}</span>`</span>;
      <span class="hljs-keyword">if</span> (!args2[<span class="hljs-string">"--no-request-logging"</span>])
        logger.http(chalk2.dim(formattedTime), chalk2.yellow(ipAddress), chalk2.cyan(requestUrl));
      <span class="hljs-keyword">if</span> (args2[<span class="hljs-string">"--cors"</span>]) {
        response.setHeader(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
        response.setHeader(<span class="hljs-string">"Access-Control-Allow-Credentials"</span>, <span class="hljs-string">"true"</span>);
        response.setHeader(<span class="hljs-string">"Access-Control-Allow-Private-Network"</span>, <span class="hljs-string">"true"</span>);
      }
      <span class="hljs-keyword">if</span> (!args2[<span class="hljs-string">"--no-compression"</span>])
        <span class="hljs-keyword">await</span> compress(request, response);
      <span class="hljs-keyword">await</span> handler(request, response, config2);
      <span class="hljs-keyword">const</span> responseTime = <span class="hljs-built_in">Date</span>.now() - requestTime.getTime();
      <span class="hljs-keyword">if</span> (!args2[<span class="hljs-string">"--no-request-logging"</span>])
        logger.http(chalk2.dim(formattedTime), chalk2.yellow(ipAddress), chalk2[response.statusCode &lt; <span class="hljs-number">400</span> ? <span class="hljs-string">"green"</span> : <span class="hljs-string">"red"</span>](<span class="hljs-string">`Returned <span class="hljs-subst">${response.statusCode}</span> in <span class="hljs-subst">${responseTime}</span> ms`</span>));
    };
    run().catch(<span class="hljs-function">(<span class="hljs-params">error2</span>) =&gt;</span> {
      <span class="hljs-keyword">throw</span> error2;
    });
  };
  <span class="hljs-keyword">const</span> sslCert = args2[<span class="hljs-string">"--ssl-cert"</span>];
  <span class="hljs-keyword">const</span> sslKey = args2[<span class="hljs-string">"--ssl-key"</span>];
  <span class="hljs-keyword">const</span> sslPass = args2[<span class="hljs-string">"--ssl-pass"</span>];
  <span class="hljs-keyword">const</span> isPFXFormat = sslCert &amp;&amp; <span class="hljs-regexp">/[.](?&lt;extension&gt;pfx|p12)$/</span>.exec(sslCert) !== <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> useSsl = sslCert &amp;&amp; (sslKey || sslPass || isPFXFormat);
  <span class="hljs-keyword">let</span> serverConfig = {};
  <span class="hljs-keyword">if</span> (useSsl &amp;&amp; sslCert &amp;&amp; sslKey) {
    serverConfig = {
      <span class="hljs-attr">key</span>: <span class="hljs-keyword">await</span> readFile(sslKey),
      <span class="hljs-attr">cert</span>: <span class="hljs-keyword">await</span> readFile(sslCert),
      <span class="hljs-attr">passphrase</span>: sslPass ? <span class="hljs-keyword">await</span> readFile(sslPass, <span class="hljs-string">"utf8"</span>) : <span class="hljs-string">""</span>
    };
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (useSsl &amp;&amp; sslCert &amp;&amp; isPFXFormat) {
    serverConfig = {
      <span class="hljs-attr">pfx</span>: <span class="hljs-keyword">await</span> readFile(sslCert),
      <span class="hljs-attr">passphrase</span>: sslPass ? <span class="hljs-keyword">await</span> readFile(sslPass, <span class="hljs-string">"utf8"</span>) : <span class="hljs-string">""</span>
    };
  }
  <span class="hljs-keyword">const</span> server = useSsl ? https.createServer(serverConfig, serverHandler) : http2.createServer(serverHandler);
  <span class="hljs-keyword">const</span> getServerDetails = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    registerCloseListener(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> server.close());
    <span class="hljs-keyword">const</span> details = server.address();
    <span class="hljs-keyword">let</span> local;
    <span class="hljs-keyword">let</span> network;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> details === <span class="hljs-string">"string"</span>) {
      local = details;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> details === <span class="hljs-string">"object"</span> &amp;&amp; details.port) {
      <span class="hljs-keyword">let</span> address;
      <span class="hljs-keyword">if</span> (details.address === <span class="hljs-string">"::"</span>)
        address = <span class="hljs-string">"localhost"</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (details.family === <span class="hljs-string">"IPv6"</span>)
        address = <span class="hljs-string">`[<span class="hljs-subst">${details.address}</span>]`</span>;
      <span class="hljs-keyword">else</span>
        address = details.address;
      <span class="hljs-keyword">const</span> ip = getNetworkAddress();
      <span class="hljs-keyword">const</span> protocol = useSsl ? <span class="hljs-string">"https"</span> : <span class="hljs-string">"http"</span>;
      local = <span class="hljs-string">`<span class="hljs-subst">${protocol}</span>://<span class="hljs-subst">${address}</span>:<span class="hljs-subst">${details.port}</span>`</span>;
      network = ip ? <span class="hljs-string">`<span class="hljs-subst">${protocol}</span>://<span class="hljs-subst">${ip}</span>:<span class="hljs-subst">${details.port}</span>`</span> : <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">return</span> {
      local,
      network,
      previous
    };
  };
  server.on(<span class="hljs-string">"error"</span>, (error2) =&gt; {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Failed to serve: <span class="hljs-subst">${error2.stack?.toString() ?? error2.message}</span>`</span>);
  });
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> endpoint.port === <span class="hljs-string">"number"</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(endpoint.port) &amp;&amp; endpoint.port !== <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> port = endpoint.port;
    <span class="hljs-keyword">const</span> isClosed = <span class="hljs-keyword">await</span> isPortReachable(port, {
      <span class="hljs-attr">host</span>: endpoint.host ?? <span class="hljs-string">"localhost"</span>
    });
    <span class="hljs-keyword">if</span> (isClosed)
      <span class="hljs-keyword">return</span> startServer({ <span class="hljs-attr">port</span>: <span class="hljs-number">0</span> }, config2, args2, port);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve2, _reject</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> endpoint.port !== <span class="hljs-string">"undefined"</span> &amp;&amp; <span class="hljs-keyword">typeof</span> endpoint.host === <span class="hljs-string">"undefined"</span>)
      server.listen(endpoint.port, () =&gt; resolve2(getServerDetails()));
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> endpoint.port === <span class="hljs-string">"undefined"</span> &amp;&amp; <span class="hljs-keyword">typeof</span> endpoint.host !== <span class="hljs-string">"undefined"</span>)
      server.listen(endpoint.host, () =&gt; resolve2(getServerDetails()));
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> endpoint.port !== <span class="hljs-string">"undefined"</span> &amp;&amp; <span class="hljs-keyword">typeof</span> endpoint.host !== <span class="hljs-string">"undefined"</span>)
      server.listen(endpoint.port, endpoint.host, () =&gt; resolve2(getServerDetails()));
  });
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>source/utilities/cli.ts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> { parse <span class="hljs-keyword">as</span> parseUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:url"</span>;
<span class="hljs-keyword">import</span> { env } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:process"</span>;
<span class="hljs-keyword">import</span> chalk3 <span class="hljs-keyword">from</span> <span class="hljs-string">"chalk"</span>;
<span class="hljs-keyword">import</span> chalkTemplate <span class="hljs-keyword">from</span> <span class="hljs-string">"chalk-template"</span>;
<span class="hljs-keyword">import</span> parseArgv <span class="hljs-keyword">from</span> <span class="hljs-string">"arg"</span>;
<span class="hljs-keyword">import</span> checkForUpdate <span class="hljs-keyword">from</span> <span class="hljs-string">"update-check"</span>;
<span class="hljs-keyword">var</span> helpText = chalkTemplate<span class="hljs-string">`
  {bold.cyan serve} - Static file serving and directory listing

  {bold USAGE}

    {bold $} {cyan serve} --help
    {bold $} {cyan serve} --version
    {bold $} {cyan serve} folder_name
    {bold $} {cyan serve} [-l {underline listen_uri} [-l ...]] [{underline directory}]

    By default, {cyan serve} will listen on {bold 0.0.0.0:3000} and serve the
    current working directory on that address.

    Specifying a single {bold --listen} argument will overwrite the default, not supplement it.

  {bold OPTIONS}

    --help                              Shows this help message

    -v, --version                       Displays the current version of serve

    -l, --listen {underline listen_uri}             Specify a URI endpoint on which to listen (see below) -
                                        more than one may be specified to listen in multiple places

    -p                                  Specify custom port

    -s, --single                        Rewrite all not-found requests to \`index.html\`

    -d, --debug                         Show debugging information

    -c, --config                        Specify custom path to \`serve.json\`

    -L, --no-request-logging            Do not log any request information to the console.

    -C, --cors                          Enable CORS, sets \`Access-Control-Allow-Origin\` to \`*\`

    -n, --no-clipboard                  Do not copy the local address to the clipboard

    -u, --no-compression                Do not compress files

    --no-etag                           Send \`Last-Modified\` header instead of \`ETag\`

    -S, --symlinks                      Resolve symlinks instead of showing 404 errors
    
    --ssl-cert                          Optional path to an SSL/TLS certificate to serve with HTTPS
                                        {grey Supported formats: PEM (default) and PKCS12 (PFX)}
    
    --ssl-key                           Optional path to the SSL/TLS certificate\'s private key
                                        {grey Applicable only for PEM certificates}

    --ssl-pass                          Optional path to the SSL/TLS certificate\'s passphrase

    --no-port-switching                 Do not open a port other than the one specified when it\'s taken.

  {bold ENDPOINTS}

    Listen endpoints (specified by the {bold --listen} or {bold -l} options above) instruct {cyan serve}
    to listen on one or more interfaces/ports, UNIX domain sockets, or Windows named pipes.

    For TCP ports on hostname "localhost":

      {bold $} {cyan serve} -l {underline 1234}

    For TCP (traditional host/port) endpoints:

      {bold $} {cyan serve} -l tcp://{underline hostname}:{underline 1234}

    For UNIX domain socket endpoints:

      {bold $} {cyan serve} -l unix:{underline /path/to/socket.sock}

    For Windows named pipe endpoints:

      {bold $} {cyan serve} -l pipe:\\\\.\\pipe\\{underline PipeName}
`</span>;
<span class="hljs-keyword">var</span> getHelpText = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> helpText;
<span class="hljs-keyword">var</span> parseEndpoint = <span class="hljs-function">(<span class="hljs-params">uriOrPort</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">Number</span>(uriOrPort)))
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">port</span>: <span class="hljs-built_in">Number</span>(uriOrPort) };
  <span class="hljs-keyword">const</span> endpoint = uriOrPort;
  <span class="hljs-keyword">const</span> url = parseUrl(endpoint);
  <span class="hljs-keyword">switch</span> (url.protocol) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"pipe:"</span>: {
      <span class="hljs-keyword">const</span> pipe = endpoint.replace(<span class="hljs-regexp">/^pipe:/</span>, <span class="hljs-string">""</span>);
      <span class="hljs-keyword">if</span> (!pipe.startsWith(<span class="hljs-string">"\\\\.\\"</span>))
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Invalid Windows named pipe endpoint: <span class="hljs-subst">${endpoint}</span>`</span>);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">host</span>: pipe };
    }
    <span class="hljs-keyword">case</span> <span class="hljs-string">"unix:"</span>:
      <span class="hljs-keyword">if</span> (!url.pathname)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Invalid UNIX domain socket endpoint: <span class="hljs-subst">${endpoint}</span>`</span>);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">host</span>: url.pathname };
    <span class="hljs-keyword">case</span> <span class="hljs-string">"tcp:"</span>:
      url.port = url.port ?? <span class="hljs-string">"3000"</span>;
      url.hostname = url.hostname ?? <span class="hljs-string">"localhost"</span>;
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">port</span>: <span class="hljs-built_in">Number</span>(url.port),
        <span class="hljs-attr">host</span>: url.hostname
      };
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Unknown --listen endpoint scheme (protocol): <span class="hljs-subst">${url.protocol ?? <span class="hljs-string">"undefined"</span>}</span>`</span>);
  }
};
<span class="hljs-keyword">var</span> options = {
  <span class="hljs-string">"--help"</span>: <span class="hljs-built_in">Boolean</span>,
  <span class="hljs-string">"--version"</span>: <span class="hljs-built_in">Boolean</span>,
  <span class="hljs-string">"--listen"</span>: [parseEndpoint],
  <span class="hljs-string">"--single"</span>: <span class="hljs-built_in">Boolean</span>,
  <span class="hljs-string">"--debug"</span>: <span class="hljs-built_in">Boolean</span>,
  <span class="hljs-string">"--config"</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-string">"--no-clipboard"</span>: <span class="hljs-built_in">Boolean</span>,
  <span class="hljs-string">"--no-compression"</span>: <span class="hljs-built_in">Boolean</span>,
  <span class="hljs-string">"--no-etag"</span>: <span class="hljs-built_in">Boolean</span>,
  <span class="hljs-string">"--symlinks"</span>: <span class="hljs-built_in">Boolean</span>,
  <span class="hljs-string">"--cors"</span>: <span class="hljs-built_in">Boolean</span>,
  <span class="hljs-string">"--no-port-switching"</span>: <span class="hljs-built_in">Boolean</span>,
  <span class="hljs-string">"--ssl-cert"</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-string">"--ssl-key"</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-string">"--ssl-pass"</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-string">"--no-request-logging"</span>: <span class="hljs-built_in">Boolean</span>,
  <span class="hljs-string">"-h"</span>: <span class="hljs-string">"--help"</span>,
  <span class="hljs-string">"-v"</span>: <span class="hljs-string">"--version"</span>,
  <span class="hljs-string">"-l"</span>: <span class="hljs-string">"--listen"</span>,
  <span class="hljs-string">"-s"</span>: <span class="hljs-string">"--single"</span>,
  <span class="hljs-string">"-d"</span>: <span class="hljs-string">"--debug"</span>,
  <span class="hljs-string">"-c"</span>: <span class="hljs-string">"--config"</span>,
  <span class="hljs-string">"-n"</span>: <span class="hljs-string">"--no-clipboard"</span>,
  <span class="hljs-string">"-u"</span>: <span class="hljs-string">"--no-compression"</span>,
  <span class="hljs-string">"-S"</span>: <span class="hljs-string">"--symlinks"</span>,
  <span class="hljs-string">"-C"</span>: <span class="hljs-string">"--cors"</span>,
  <span class="hljs-string">"-L"</span>: <span class="hljs-string">"--no-request-logging"</span>,
  <span class="hljs-string">"-p"</span>: <span class="hljs-string">"--listen"</span>
};
<span class="hljs-keyword">var</span> parseArguments = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> parseArgv(options);
<span class="hljs-keyword">var</span> checkForUpdates = <span class="hljs-keyword">async</span> (manifest) =&gt; {
  <span class="hljs-keyword">if</span> (env.NO_UPDATE_CHECK)
    <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">const</span> [error2, update] = <span class="hljs-keyword">await</span> resolve(checkForUpdate(manifest));
  <span class="hljs-keyword">if</span> (error2)
    <span class="hljs-keyword">throw</span> error2;
  <span class="hljs-keyword">if</span> (!update)
    <span class="hljs-keyword">return</span>;
  logger.log(chalk3.bgRed.white(<span class="hljs-string">" UPDATE "</span>), <span class="hljs-string">`The latest version of \`serve\` is <span class="hljs-subst">${update.latest}</span>`</span>);
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>source/utilities/config.ts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> {
  resolve <span class="hljs-keyword">as</span> resolvePath,
  relative <span class="hljs-keyword">as</span> resolveRelativePath
} <span class="hljs-keyword">from</span> <span class="hljs-string">"node:path"</span>;
<span class="hljs-keyword">import</span> { readFile <span class="hljs-keyword">as</span> readFile2 } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:fs/promises"</span>;
<span class="hljs-keyword">import</span> Ajv <span class="hljs-keyword">from</span> <span class="hljs-string">"ajv"</span>;
<span class="hljs-keyword">import</span> schema <span class="hljs-keyword">from</span> <span class="hljs-string">"@zeit/schemas/deployment/config-static.js"</span>;
<span class="hljs-keyword">var</span> loadConfiguration = <span class="hljs-keyword">async</span> (presentDirectory2, directoryToServe2, args2) =&gt; {
  <span class="hljs-keyword">const</span> files = [<span class="hljs-string">"serve.json"</span>, <span class="hljs-string">"now.json"</span>, <span class="hljs-string">"package.json"</span>];
  <span class="hljs-keyword">if</span> (args2[<span class="hljs-string">"--config"</span>])
    files.unshift(args2[<span class="hljs-string">"--config"</span>]);
  <span class="hljs-keyword">const</span> config2 = {};
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files) {
    <span class="hljs-keyword">const</span> location = resolvePath(directoryToServe2, file);
    <span class="hljs-keyword">const</span> [error2, rawContents] = <span class="hljs-keyword">await</span> resolve(readFile2(location, <span class="hljs-string">"utf8"</span>));
    <span class="hljs-keyword">if</span> (error2) {
      <span class="hljs-keyword">if</span> (error2.code === <span class="hljs-string">"ENOENT"</span> &amp;&amp; file !== args2[<span class="hljs-string">"--config"</span>])
        <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Could not read configuration from file <span class="hljs-subst">${location}</span>: <span class="hljs-subst">${error2.message}</span>`</span>);
    }
    <span class="hljs-keyword">let</span> parsedJson;
    <span class="hljs-keyword">try</span> {
      parsedJson = <span class="hljs-built_in">JSON</span>.parse(rawContents);
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> parsedJson !== <span class="hljs-string">"object"</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"configuration is not an object"</span>);
    } <span class="hljs-keyword">catch</span> (parserError) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Could not parse <span class="hljs-subst">${location}</span> as JSON: <span class="hljs-subst">${parserError.message}</span>`</span>);
    }
    <span class="hljs-keyword">if</span> (file === <span class="hljs-string">"now.json"</span>) {
      parsedJson = parsedJson;
      parsedJson = parsedJson.now.static;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file === <span class="hljs-string">"package.json"</span>) {
      parsedJson = parsedJson;
      parsedJson = parsedJson.static;
    }
    <span class="hljs-keyword">if</span> (!parsedJson)
      <span class="hljs-keyword">continue</span>;
    <span class="hljs-built_in">Object</span>.assign(config2, parsedJson);
    <span class="hljs-keyword">if</span> (file === <span class="hljs-string">"now.json"</span> || file === <span class="hljs-string">"package.json"</span>)
      logger.warn(<span class="hljs-string">"The config files `now.json` and `package.json` are deprecated. Please use `serve.json`."</span>);
    <span class="hljs-keyword">break</span>;
  }
  <span class="hljs-keyword">if</span> (directoryToServe2) {
    <span class="hljs-keyword">const</span> staticDirectory = config2.public;
    config2.public = resolveRelativePath(presentDirectory2, staticDirectory ? resolvePath(directoryToServe2, staticDirectory) : directoryToServe2);
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(config2).length !== <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> ajv = <span class="hljs-keyword">new</span> Ajv({ <span class="hljs-attr">allowUnionTypes</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-keyword">const</span> validate = ajv.compile(schema);
    <span class="hljs-keyword">if</span> (!validate(config2) &amp;&amp; validate.errors) {
      <span class="hljs-keyword">const</span> defaultMessage = <span class="hljs-string">"The configuration you provided is invalid:"</span>;
      <span class="hljs-keyword">const</span> error2 = validate.errors[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${defaultMessage}</span>
<span class="hljs-subst">${error2.message ?? <span class="hljs-string">""</span>}</span>
<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error2.params)}</span>`</span>);
    }
  }
  config2.etag = !args2[<span class="hljs-string">"--no-etag"</span>];
  config2.symlinks = args2[<span class="hljs-string">"--symlinks"</span>] || config2.symlinks;
  <span class="hljs-keyword">return</span> config2;
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>source/main.ts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> [parseError, args] = <span class="hljs-keyword">await</span> resolve(parseArguments());
<span class="hljs-keyword">if</span> (parseError || !args) {
  logger.error(parseError.message);
  exit(<span class="hljs-number">1</span>);
}
<span class="hljs-keyword">var</span> [updateError] = <span class="hljs-keyword">await</span> resolve(checkForUpdates(package_default));
<span class="hljs-keyword">if</span> (updateError) {
  <span class="hljs-keyword">const</span> suffix = args[<span class="hljs-string">"--debug"</span>] ? <span class="hljs-string">":"</span> : <span class="hljs-string">" (use `--debug` to see full error)"</span>;
  logger.warn(<span class="hljs-string">`Checking for updates failed<span class="hljs-subst">${suffix}</span>`</span>);
  <span class="hljs-keyword">if</span> (args[<span class="hljs-string">"--debug"</span>])
    logger.error(updateError.message);
}
<span class="hljs-keyword">if</span> (args[<span class="hljs-string">"--version"</span>]) {
  logger.log(package_default.version);
  exit(<span class="hljs-number">0</span>);
}
<span class="hljs-keyword">if</span> (args[<span class="hljs-string">"--help"</span>]) {
  logger.log(getHelpText());
  exit(<span class="hljs-number">0</span>);
}
<span class="hljs-keyword">if</span> (!args[<span class="hljs-string">"--listen"</span>])
  args[<span class="hljs-string">"--listen"</span>] = [{ <span class="hljs-attr">port</span>: <span class="hljs-built_in">parseInt</span>(env2.PORT ?? <span class="hljs-string">"3000"</span>, <span class="hljs-number">10</span>) }];
<span class="hljs-keyword">if</span> (args._.length &gt; <span class="hljs-number">1</span>) {
  logger.error(<span class="hljs-string">"Please provide one path argument at maximum"</span>);
  exit(<span class="hljs-number">1</span>);
}
<span class="hljs-keyword">var</span> presentDirectory = getPwd();
<span class="hljs-keyword">var</span> directoryToServe = args._[<span class="hljs-number">0</span>] ? path.resolve(args._[<span class="hljs-number">0</span>]) : presentDirectory;
<span class="hljs-keyword">var</span> [configError, config] = <span class="hljs-keyword">await</span> resolve(loadConfiguration(presentDirectory, directoryToServe, args));
<span class="hljs-keyword">if</span> (configError || !config) {
  logger.error(configError.message);
  exit(<span class="hljs-number">1</span>);
}
<span class="hljs-keyword">if</span> (args[<span class="hljs-string">"--single"</span>]) {
  <span class="hljs-keyword">const</span> { rewrites } = config;
  <span class="hljs-keyword">const</span> existingRewrites = <span class="hljs-built_in">Array</span>.isArray(rewrites) ? rewrites : [];
  config.rewrites = [
    {
      <span class="hljs-attr">source</span>: <span class="hljs-string">"**"</span>,
      <span class="hljs-attr">destination</span>: <span class="hljs-string">"/index.html"</span>
    },
    ...existingRewrites
  ];
}
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> endpoint <span class="hljs-keyword">of</span> args[<span class="hljs-string">"--listen"</span>]) {
  <span class="hljs-keyword">const</span> { local, network, previous } = <span class="hljs-keyword">await</span> startServer(endpoint, config, args);
  <span class="hljs-keyword">const</span> copyAddress = !args[<span class="hljs-string">"--no-clipboard"</span>];
  <span class="hljs-keyword">if</span> (!stdout.isTTY || env2.NODE_ENV === <span class="hljs-string">"production"</span>) {
    <span class="hljs-keyword">const</span> suffix = local ? <span class="hljs-string">` at <span class="hljs-subst">${local}</span>`</span> : <span class="hljs-string">""</span>;
    logger.info(<span class="hljs-string">`Accepting connections<span class="hljs-subst">${suffix}</span>`</span>);
    <span class="hljs-keyword">continue</span>;
  }
  <span class="hljs-keyword">let</span> message = chalk4.green(<span class="hljs-string">"Serving!"</span>);
  <span class="hljs-keyword">if</span> (local) {
    <span class="hljs-keyword">const</span> prefix = network ? <span class="hljs-string">"- "</span> : <span class="hljs-string">""</span>;
    <span class="hljs-keyword">const</span> space = network ? <span class="hljs-string">"    "</span> : <span class="hljs-string">"  "</span>;
    message += <span class="hljs-string">`

<span class="hljs-subst">${chalk4.bold(<span class="hljs-string">`<span class="hljs-subst">${prefix}</span>Local:`</span>)}</span><span class="hljs-subst">${space}</span><span class="hljs-subst">${local}</span>`</span>;
  }
  <span class="hljs-keyword">if</span> (network)
    message += <span class="hljs-string">`
<span class="hljs-subst">${chalk4.bold(<span class="hljs-string">"- Network:"</span>)}</span>  <span class="hljs-subst">${network}</span>`</span>;
  <span class="hljs-keyword">if</span> (previous)
    message += chalk4.red(<span class="hljs-string">`

This port was picked because <span class="hljs-subst">${chalk4.underline(previous.toString())}</span> is in use.`</span>);
  <span class="hljs-keyword">if</span> (copyAddress &amp;&amp; local) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> clipboard.write(local);
      message += <span class="hljs-string">`

<span class="hljs-subst">${chalk4.grey(<span class="hljs-string">"Copied local address to clipboard!"</span>)}</span>`</span>;
    } <span class="hljs-keyword">catch</span> (error2) {
      logger.error(<span class="hljs-string">`Cannot copy server address to clipboard: <span class="hljs-subst">${error2.message}</span>.`</span>);
    }
  }
  logger.log(boxen(message, {
    <span class="hljs-attr">padding</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">borderColor</span>: <span class="hljs-string">"green"</span>,
    <span class="hljs-attr">margin</span>: <span class="hljs-number">1</span>
  }));
}
registerCloseListener(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  logger.log();
  logger.info(<span class="hljs-string">"Gracefully shutting down. Please wait..."</span>);
  process.on(<span class="hljs-string">"SIGINT"</span>, () =&gt; {
    logger.log();
    logger.warn(<span class="hljs-string">"Force-closing all open sockets..."</span>);
    exit(<span class="hljs-number">0</span>);
  });
});

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
